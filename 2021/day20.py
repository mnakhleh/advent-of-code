from itertools import product
from collections import Counter


TEST_ALGO = """..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..##
#..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###
.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#.
.#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#.....
.#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#..
...####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.....
..##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#"""

TEST_IMG = """#..#.
#....
##..#
..#..
..###"""

INPUT_ALGO = """#.#..##..##....#.####.#...##..###..#.#.##..##....###..#.##.#.#.#......##...#..##...#####.##..##...##..#.
##.##..###.##.##...##....###.##.#...#.#.##..#..###.#.##.#.##.####.###.#..#######.##..##..#.##..#####.#..###.####.##....
####.#....#...#..#..#....#..#...####.....#.##.###.##.##.###..###.##.###...#.##..#.###.##..##..#.##...##....##.#...#..#..
.#.##.#..#.###...#.#.##...#..#......#.#...#######.###.##.####.#.#.#.#.#.#.#######....##.##.##..##.##....##....##.##..###
#..#.#.##...###.##...#..##...#####.#.#.##.#.####.
"""

INPUT_IMG = """##.##.#.#..##...####..##...#....#....##.##..##..##..##.#..###.....#########...#..##.###....#...##...
#...#.#####.#.##.#.#####...#.#####..#.##.##..##.....#..#.......#.###..#..#..#####..#.##.##.#...#..##
###...###..###.#.####....#######..#..#..#..###..#.######...##.#..#..#..##.#....#.....####.#...##....
##.#..###...#..#.#######.#.##..####.###.###...###.#...#.#...######......#.#.#...#.##..........#..#.#
.....#...###.##..##.#.########.##.#..#..###..#..##...##.###.#.#..#######..##.###.#..#..##.##.#...###
.#.#.###....###...##.#...##...#.#.#...#.#.##..##.#..#.##.#..####.###...##....###..#......###.......#
.###.#.##.#.#####..##.###.##....#.##.####...#.#..###.##..####...#..#####.......#.###.###.##....#..#.
##...#.##..##...###.#......###....####..###.......###..####.##.####.##.....#.#.##.###.######..#.....
###..#...#.#.#...#..#...##..###.#..###.####.#..#..##..##.###.####..##...##..###........#...###..##..
...#...#..#..#..######..##..##.#..##...#.#.#...##.#.##.####..#..##.##..#.###.#.#.##.#.##..###.###..#
#...#...#..#######...##.#....##.##...##....#.##....#.#.....#.#..#..#.#..##.#........##.#.##.....#.#.
###.#.....#######.#...####..##...#.#....####.#....#.######.#..###......#.#....##..####.##..#.#.##.##
..#..#...##.##.##...#...####....##.#.####...##...#...#..#....#.#.#####....#.#.##......##..#..#...###
###..###..#.##...#.####.#..#..#...#.##.######.#.##.##.#######.#...#.####.###...#.#............##..##
#.####...#..#.##.#....######.####.##........#.#..#...#..##.....#..#...#..###...###.#..#.#.##..##.#.#
##.##..##.###.#...#.##.....#.#..##...####...#.#..###..###...#....######..##...#.##...#...#...#...#.#
##.#.....##...#.##..#...#.####....#....##.##.#.#.######..##.#.##.####.#.#..#.#.##.#.#...#.....###.##
..##...###..###.......#.....#.#..#.#######..##....##...##...#.#.#.#...##.####.....#.##..###..##.....
#.#..######.####.####.##.##.###.####..#....####..#.#######......##...#...####.##.#######..###..####.
##.###...##.##....######.#.##.#...###.##.##.#......###.#..###...#...........#.......###.####.##..#..
##.#......#.#.....##.##.###.#####.######..#.#...##.#.#.#..#.#...#..#.#.#.####.##.###.##.######.#.#..
.#..#.##.###.####.##.##..##...####..#.##.##.##...##...##.####.#####.#..##.#...##..#..##.#..#.#..#.##
#..###.#.#######.###.......#####.#.#.###.#.##.##.####.#####...#..#....#.#....#...##......#.#..#....#
.#..###.....##..###...##...####..#..##.##.#..#.#.#..####..#.......##.##...#.###..#...#....#........#
#.#.#.#...#.###.........###....#...##.##.##..#..#...####...##.###...#.##.##..##....##.#...####.#.###
..#.#..#.#.......#.#....####.##.#.#........#.#.##..###.#..#.##..##..##.###.#....#.###.#.##.####.#..#
....#.###..#.#######...###.#..#..##.#.#....##.#.#.#.....###.#..###......#....#######......#...#.#.#.
#.#.#.#...#.#...#######...###.###..##.#...####...#####...#..##......#..##.#........#.#..##.#.###....
#...##.#..##..#.#..#.#.....######..##...#.##.#.##.##.###..#.##.#..##.###.####...###...#.###..##.#.#.
#.#.##..#..#..##.....#####........#.##..#.#.#.#.#.#.#.#..#####.#.#.....###..#.###..#.##.##.#######.#
.##.#.#.##.##.#..#.###..#..##..###..#..#..#.###...###.#.#....##..#.##...##..#..##.#.#.#.#.#####.##.#
#.#.......###.#...##.##.##.......##.###.#..###.#..#....#.#.####....#.###.##...##.#...##...#..###.##.
#..###.#.##.#..#####..##.#.########.#.###.####....##.###.##.#..######...#.#..#..###.#...#.#...##...#
.#.#.#..#.##..####...#.##.#..#.#........##.#.#....##.##.#.....###.#.#.#...#.#####..#.#...##.#..####.
#.##...########.##.......##.#.####.#...#.##.#######..#...........#.#.###..###...#.####.##.#####..###
...#..##.###.#.#.#...###..###....#..#.##..##.####..#.###..##...#..##.....###.##.##.#.####.####..#.#.
.#.#.#.....##.#.###...###..#.#...###.#.....##....#.#.###..#....##.....#.#...#.#.##..#..#...#.#.#.#.#
#.#.#.#######.#.##..######...##########.#.##.#.###.##.#..#..#....##......#...##.##..###.##.####.#...
#..##..##.##....#..###..##.....##....##.#.#...#....##...#..#.#..#...#..####....#.##.....#.##.#......
....##..##.#.#........#.#.#...##.##......####.....#.####.#.##....#....#.###.#....#.####.####....#.##
...###.#..#..###.####...#.#...#####..#...##..#.#..#..#.####....#...#####.###.##.#####....###.##.####
###..##.....##.#.#.#.#.#.#.#.###..##..#..........###..#.###.####...##..#.#.#.#.##.#..###....#.####..
...#...#..#.............###.##..##.###.#.######...#.###.##..##.#######...###.###.#..##.####.#..#.###
#..##.##...###..#####.####..##..#.#.#..##..##..#.....#########.##.#.###...##......#...#....#.###...#
#..##.#.###..#...###.#.#...#..###.###..##.##.#.#.#....###.####.#...###..##.#...#.##.###.#..##....###
#.#...####.##.####.#.##...##.##..#.##.#.#..##..##.....#.#.#####.#.##..##..#.##.####.#..##..#.##.##.#
..##.##...###.#.......##.......##.#..##.#.#.#.#..####.##..##..#####.#..#..#.####.#.##.#.###..#...###
##.##.###...#......##.######.#...#....#.#####.##.#.####.##.##.##.#.#...######....##.##.###..##.###..
##.#########..#.##..#..####..#.####.#.#.##..#.##.##.###.####..##..#..#.####..#.#.....#.....#.###.###
...###.#.##.##.##.##...#.#..#.####..###.....#...##.###.###..##.#.#..##.######.....#.#.###.##.##..###
#..#####.#.#....##.#.##..###.#..###...#...####.#####..#.##..#.##..###....#..##.##.###...#.#...#.....
#...#.#..#.######..##......#.####.###....##.#.##..#..#####....#..###.#.#####...###.#..##.##.....#...
##..##.###..#.#..##.##...#######..#...#..#....#.##...##.##.###.#..##.#..##...#.###.....##.#.#.#.####
##...##.###..#...#..#..#...#..##.##...###..##..#..####...#.##......##.##...#.#######.####.###....##.
...#..##.###...##....#######.###...##..##.##.#.##...#..###.#.##.#..#.#.##..###.##....#.....#.#.#.#..
..#..##..#..##.##.#.##..##.####...#.#####..####.#.##.#.#..#......##.#.##.....#.#..##..#.###.#...###.
#.....#..#...#.#.#.##########....##.####...###......#.#..#..#........#.###..#.####.####.#####.##.###
.##..#.###.##..##..######.##..###...#.##...#....#....####.###.#.###...#.###..#......#.##.###....#...
.#..#.##.##..##.###.#..#.#.##.#..##.###.###.#....#.######...#.....###.##..###.####..#.##..#.####.###
#.##.##.#.#.........#.....#.##..#.##..#.##..#.#..##.##.#..##..##########....#.##.#...#.####.#.#.#.##
.#.....###.##.#..##...#.#..##.##.#.#.#..####..#####......###..#####..###...###...##.##..#.#####..#.#
.##..#.###..#.#.###..###..##.#...###.####.######......#..##.#.####.##.#.#....#......#..#..###.##..##
###..##....#.#######.###.###.##.###..##...##.#..#.#..#....#.#.####..##..##.#####.#.#####.#...##..#.#
.##.....##..##.#.#.#..###.#..###.##.##..###.##.####...#.##..#..#.#.#.##.###.#..###....#.###.##.#.#..
####.##.###.#.##..#.###.##.#.....#.###.#.####..#..#.####.....###.#.####.#..#...###....###...##.#.#.#
#.##..#.......###.##.###.##..#..####.###.#..#####.#..##.###.#..###.####....#..#...#.####.#.##....#..
#....#.#....#.#..###.##..###..##..#####.##...#.#....###..##.#....#####.#....###.#..##.#.....####.#.#
##.###.#.##.#.....###.#.......##.###....#.#.##....##.#.##.#.#...#.#.##......#.#.##.#...#...#......##
.##.#..#.###.###..#..##.#..##.###.....#....#####..#.#..#####....####...##.##.#.####.#....##.#####.#.
#...##....#####.#.##.##.#####.#.#.##....#.#.##.#....#.....###.#....##..###.####..#..#...#...#...#..#
..#..##....##.#.##.#.###..####.#..##....#.##.#..#######...#.##.#....##...###..#..#.#.#..#.##.#.#..#.
##..###....#...####.##.###.####.###...##..####..###..##.#.##.....#####...#.#.##...#.#..######.#....#
.#...######..........#......#.##.#...##..#####...###..###..#...##.#..##.##..#..##.....###.##.##.###.
.#..##.###.##...#..#.####..#....#.#.#.#.####.##..#.#..#..###..##.#..##..###......##..#.#.##.#.##.###
.#.#.#..#####..#...#######..####..##.####.#.#####.#...####.####.##.##.#.#...#.....###.##..##.#.##...
.#...######...###.##.#...#...#...##.#..#...#.#..#.#.##.#.#.#...###.####.##..##.##..###..#.#..#.#.#.#
.###.#...#.##.###.########......#.###.###.#.###.....###.#..####..#..#.#.#####....#.#...#.#....###..#
#.#.#...#....#####.##.#.###.##.#..#####.......#..#.##..#.#....###.#..#.##..#..#.#..######...#...###.
.####.#.#.#..####.#####..###.#.##.##..#######.#.#.###..#.##.###.#....##.####.#.#.##.##.#.###....#..#
#.#.##..#..##.####.#.#..####..#..#####.########..###.#.###....##...##.####..#......##.#.#.#.#..#...#
....#.....###..##...##.##..#####.##..###.#...##....##.#####..####.....####..#..####..###.##....#.###
.....###..#......#....#.###....#.###.#.#.#.#.###.##.##...###.##.#####...#....#.##..##..##..#.#..##..
#.##..#.#..#..##..#..###...#..#.######.##.##.#.####...##.#..#..##...##.#.###..###.####.##...#..#....
###...###..#..#####..###.#####....##..#..#...#.###.##..##..########.##....#...#..##......##..#.##...
..#.#..###..#......#.#...####.....#.#...######..#.....#..###.##..##.#...##.#..##.##..##..##.#####.##
#.#..#......###..##.#####..#####...##.#.#####.######.#..##....##.##.#.#..#....#.#...##.#.###.#.##.#.
.####...##.####....##..####.#..####..#.....###.###..#####..###.##.#.####.##.#..#.#.#..#..##..##.#.##
#.####..#.###.#.#...#.###.##..#......######.#...#####..#.###..#..#####.#.#.##.#..#..##...#.....##.##
..#..##......#.#.##.####...#.######..####..##.###.##..#.#..#.########...#.#...###.##..###.#.####..##
..#......#..#..#.#.#.#####.#..###...#.#.#...#.##.##.##.##.#.##.#####.####.#..##.######..#.##..#...##
###.##.#..#.##.#..###..##.##.#..#.####..#....####.##.#.##...#.##......##.#...#....###.#.....####.###
..########.##..##.###..##.###.##..#.#.##.#.#....####.##.####.##.###....#.###.########.#.##.#.#######
..#.#.....#..#....#####.#.#..#...##.#.....#.....#..###.##..##.####..#.##...#####..####.....#..#..###
##...###.######.##.#..#....#.##.#..#..#.#####..#.######..#..##...##.#..#...##.#.#..#.##.#######...##
....#..#.#.#####.###.##.##.#.##..#.#....#.##.###...###.##..#.####..##.#...####.#....#....#.##...##..
.####....####.##.#..#..####.#..#..##....##.#..##.##..##.###....##..##.........##.#.####......####.#.
...#.#.#..####...#.#.#.......#..##.#.#..#.#..##..####..#....###....#..###.##.#..#.###.###.###.##.#..
##.#..#.#.####.###.#.#.###.....###...#.###.#.##.#.#..#..#.#..###.....###.#.#...########...#..#.#..##
..#..##..#...#.#..##.#.#...#..#..#..###.##.##.#.#.#......#..###.#.....##..#.#.#.#.#...###.#..#.#.##.
#.####.#..###.###.#....#.##..##.#.##..#.####....#.##.#...##.....#####..#.#..##..#.##..#......##..##."""


PERS_IMG = """#..##.##
###.#.#.
#..#..#.
#.#..#..
#..#....
#.######"""


def pad_image(txt, nb_padding=1, padchar='.'):
    width = len(txt.split('\n')[0])
    padded = '\n'.join(padchar * (width + 2*nb_padding) for _ in range(nb_padding))
    for line in txt.split('\n'):
        padded += '\n' + padchar * nb_padding + line + padchar * nb_padding
    return padded + '\n' + '\n'.join(padchar * (width + 2*nb_padding) for _ in range(nb_padding))


def bin_img(y, x, txt, padval='0'):
    height = len(txt.split('\n'))
    width = len(txt.split('\n')[0])
    bin_as_txt = ''
    for j, i in product(range(-1, 2), range(-1, 2)):
        if not 0 <= x + i < width:
            val = padval
        elif not 0 <= y + j < height:
            val = padval
        elif txt.split('\n')[y + j][x + i] == '#':
            val = '1'
        else:
            val = '0'
        bin_as_txt += val
    return int(bin_as_txt, 2)


def enhance(txt, algo, padchar='.'):
    txt = pad_image(txt, 1, padchar)
    algo_hash = [char for char in algo.replace('\n', '')]
    height = len(txt.split('\n'))
    width = len(txt.split('\n')[0])
    new_img = ''
    padval = '0' if padchar == '.' else '1'

    for y, x in product(range(height), range(width)):
        bin_val = bin_img(y, x, txt, padval)
        new_img += algo_hash[bin_val]
        if x == width - 1:
            new_img += '\n'
    return new_img[:-1]


def countit(img):
    count = Counter(img)
    return count['#']


##########################
if __name__ == '__main__':
    # img = enhance(enhance(TEST_IMG, TEST_ALGO), TEST_ALGO)
    # assert countit(img) == 35
    # img_input1 = enhance(PERS_IMG, INPUT_ALGO)
    # img_input2 = enhance(img_input1, INPUT_ALGO)
    img_orig = INPUT_IMG

    for i in range(2):
        print(f"On {i}")
        padchar = '.' if i % 2 == 0 else '#'
        img_enhanced = enhance(img_orig, INPUT_ALGO, padchar=padchar)
        img_orig = img_enhanced
    print(img_enhanced)
    print(countit(img_enhanced))